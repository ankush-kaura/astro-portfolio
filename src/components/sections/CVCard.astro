---
import { File } from 'lucide-react'
import Card from '../Card.astro'
import { Button } from '../ui/button'
import { contentfulClient } from '../../lib/contentful'
import type { EntryFieldTypes } from 'contentful'

interface CV {
  contentTypeId: '78VSYVN5JR9O5zqLkzVfvM'
  fields: {
    title: EntryFieldTypes.Text
    description?: EntryFieldTypes.Text
    resumeFile: {
      sys: {
        type: 'Link'
        linkType: 'Asset'
        id: string
      }
      fields: {
        title: string
        file: {
          url: string
          fileName: string
          contentType: string
        }
      }
    }
    fileName?: EntryFieldTypes.Text
  }
}

const cvEntries = await contentfulClient.getEntries<CV>({
  content_type: '78VSYVN5JR9O5zqLkzVfvM'
}).catch(() => ({ items: [] }))

const cvEntry = cvEntries.items[0]
---

<Card colSpan="md:col-span-1" rowSpan="md:row-span-4" title="CV">
  <div class="mt-4 flex w-full justify-center">
    <div
      class="card card-compact md:w-112 lg:w-128 w-96 gap-2 border-[oklch(var(--p))] transition-all"
    >
      {cvEntry?.fields?.resumeFile ? (
        <>
          <div class="mt-4 flex flex-col gap-2">
            <p class="text-sm text-muted-foreground">
              {cvEntry.fields.description || 'Download my resume by clicking on the button below'}
            </p>
            <div class="card-actions mt-2 flex w-full items-center justify-start">
              <Button id="download-cv-btn" data-url={`https:${(cvEntry.fields.resumeFile as any).fields.file.url}`} data-filename={(cvEntry.fields.resumeFile as any).fields.file.fileName || 'CV.pdf'}>
                {cvEntry.fields.fileName || (cvEntry.fields.resumeFile as any).fields.file.fileName || 'Download Resume'}
                <File />
              </Button>
            </div>
          </div>
        </>
      ) : (
        <div class="flex flex-col items-center justify-center h-full text-center">
          <p class="text-sm text-muted-foreground mb-2">
            CV/Resume content not available yet
          </p>
          <p class="text-xs text-gray-500">
            Add CV entry in Contentful to display resume here
          </p>
        </div>
      )}
    </div>
  </div>

  <script>
    document.getElementById('download-cv-btn')?.addEventListener('click', function() {
      const url = this.getAttribute('data-url');
      const filename = this.getAttribute('data-filename') || 'CV.pdf';
      if (!url) return;
      fetch(url)
        .then(response => response.blob())
        .then(blob => {
          const blobUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(blobUrl);
        })
        .catch(error => console.error('Download failed:', error));
    });
  </script>
</Card>
